legend.title = element_text(face = "bold"),
legend.position = "right"
)
# Install if needed: install.packages(c("plotly", "dplyr"))
library(plotly)
library(dplyr)
# Load your result table (change path if needed)
repeats <- read.csv("/home/popadin/Documents/REPEATABILITY/data/2_derived/pos8473_TtoC/my_mtDNA_repeat_all_repeats.csv")
# 1. Filter for repeats of length 15 or 16
repeats <- repeats %>% filter(EffectiveLength %in% c(15,16))
# 2. Circle/map settings
MTDNA_LENGTH <- 16568
radius <- 1
# Helper: place 1 at top, progress clockwise around circle
angle_at <- function(pos) {
(0.5 - (pos-1)/MTDNA_LENGTH) * 2 * pi
}
# Compute arc endpoints
repeats <- repeats %>%
mutate(
pos_angle = angle_at(pos),
repeat_center = (repeat.start + repeat.end)/2,
repeat_angle = angle_at(repeat_center),
x_pos = cos(pos_angle)*radius,
y_pos = sin(pos_angle)*radius,
x_rep = cos(repeat_angle)*radius,
y_rep = sin(repeat_angle)*radius,
arc_color = ifelse(RefAlt == "Ref", "blue", "red"),
arc_width = ifelse(EffectiveLength==16, 7, 4),
arc_lab = paste0(RefAlt, ", ", EffectiveLength, " bp<br>",
"repeat: ",repeat.start,"-",repeat.end)
)
# 3. Prepare genome circle (from 1 to 16568, position 1 at top)
n_circle <- 600
theta_seq <- seq(0, 2*pi, length.out=n_circle)
x_circle <- cos(theta_seq) * radius
y_circle <- sin(theta_seq) * radius
# 4. Plot arcs using quadratic Bezier: start at pos, curve midpoint, end at repeat center
make_bezier <- function(x0, y0, x1, y1, curve=0.35, n=40) {
xm <- (x0 + x1)/2
ym <- (y0 + y1)/2
# Rotate midpoint to get control point (90deg CCW)
dx <- x1-x0; dy <- y1-y0
ctrl_x <- xm - dy*curve
ctrl_y <- ym + dx*curve
t <- seq(0,1,length.out=n)
data.frame(
x=(1-t)^2*x0 + 2*(1-t)*t*ctrl_x + t^2*x1,
y=(1-t)^2*y0 + 2*(1-t)*t*ctrl_y + t^2*y1
)
}
all_arc_traces <- list()
for(i in seq_len(nrow(repeats))) {
b <- make_bezier(repeats$x_pos[i], repeats$y_pos[i], repeats$x_rep[i], repeats$y_rep[i],
curve=0.38, n=50)
all_arc_traces[[i]] <- list(
x = b$x, y = b$y,
customdata = matrix(rep(repeats$arc_lab[i], length(b$x)), ncol=1),
mode = "lines",
type = "scatter",
line = list(
color = repeats$arc_color[i],
width = repeats$arc_width[i]
),
hovertemplate = "%{customdata}",
name = paste(repeats$RefAlt[i], repeats$EffectiveLength[i], "bp"),
showlegend = FALSE
)
}
# Build base figure
fig <- plot_ly(type = 'scatter', mode='lines',
x = x_circle, y = y_circle, line=list(color="gray", width=3),
showlegend=FALSE, hoverinfo='skip')
for(tr in all_arc_traces) fig <- add_trace(fig, inherit=FALSE, !!!tr)
# Variant position (highlight + label)
variant <- repeats[1,]
fig <- fig %>%
add_markers(x=variant$x_pos, y=variant$y_pos,
marker=list(size=18, color="goldenrod", line=list(color='black', width=3)),
hoverinfo='skip', showlegend=FALSE) %>%
add_text(x=variant$x_pos, y=variant$y_pos,
text=as.character(variant$pos),
textfont = list(color='black', size=16, family="Arial Black"),
textposition='middle right',
showlegend=FALSE)
# Label for position 1 at top
fig <- fig %>%
add_text(x=0, y=radius*1.09, text="1", textfont=list(size=15, color="black", face="bold"),
showlegend=FALSE)
# Add invisible points to supply legend
fig <- fig %>%
add_trace(x=NA, y=NA, mode="lines",
line=list(color="blue", width=7), name="Ref, 16bp", showlegend=TRUE) %>%
add_trace(x=NA, y=NA, mode="lines",
line=list(color="red", width=7), name="Alt, 16bp", showlegend=TRUE) %>%
add_trace(x=NA, y=NA, mode="lines",
line=list(color="blue", width=4), name="Ref, 15bp", showlegend=TRUE) %>%
add_trace(x=NA, y=NA, mode="lines",
line=list(color="red", width=4), name="Alt, 15bp", showlegend=TRUE)
fig <- fig %>%
layout(
title = list(
text = "mtDNA 15/16bp Repeats Connected to Variant Position",
y=0.92, x=0.5, xanchor='center', yanchor='top'),
showlegend=TRUE,
legend = list(title=list(text="<b>Repeat type</b>"),
orientation="v", y=0.98, x=1.025, xanchor="left"),
xaxis = list(showgrid=FALSE, zeroline=FALSE, visible=FALSE),
yaxis = list(showgrid=FALSE, zeroline=FALSE, visible=FALSE),
margin = list(l=25, r=130, t=70, b=25),
autosize=TRUE
)
fig
# Install if needed:
# install.packages(c("ggplot2", "dplyr", "scales"))
library(ggplot2)
library(dplyr)
library(scales)
# Genome and parameters
MTDNA_LENGTH <- 16568
radius <- 1
# Load your repeat data (edit path as needed)
repeats <- read.csv("/home/popadin/Documents/REPEATABILITY/data/2_derived/pos8473_TtoC/my_mtDNA_repeat_all_repeats.csv")
# Filter: keep only 16 bp and 15 bp repeats
repeats <- repeats %>% filter(EffectiveLength %in% c(16, 15))
if (nrow(repeats) == 0) stop("No 15 or 16 bp repeats found in your file!")
# Helper: mtDNA position (1 at top, clockwise)
angle_for_pos <- function(pos) (0.5 - (pos-1)/MTDNA_LENGTH) * 2 * pi
repeats <- repeats %>%
mutate(
angle_pos = angle_for_pos(pos),
angle_rep = angle_for_pos((repeat.start + repeat.end) / 2),
x_pos = cos(angle_pos) * radius,
y_pos = sin(angle_pos) * radius,
x_rep = cos(angle_rep) * radius,
y_rep = sin(angle_rep) * radius,
arc_color = ifelse(RefAlt == "Ref", "#3182bd", "#de2d26"),
arc_thick = ifelse(EffectiveLength == 16, 7, 4),
arc_type  = case_when(
RefAlt == "Ref" & EffectiveLength == 16 ~ "Ref, 16bp",
RefAlt == "Alt" & EffectiveLength == 16 ~ "Alt, 16bp",
RefAlt == "Ref" & EffectiveLength == 15 ~ "Ref, 15bp",
RefAlt == "Alt" & EffectiveLength == 15 ~ "Alt, 15bp"
),
arc_label = paste0(arc_type, "<br>repeat: ", repeat.start, "-", repeat.end)
)
# Genome circle
n_points <- 400
circle_path <- data.frame(x = cos(seq(0, 2*pi, length.out=n_points)) * radius,
y = sin(seq(0, 2*pi, length.out=n_points)) * radius)
# Where is position 1?
angle_1 <- angle_for_pos(1)
x1 <- cos(angle_1) * radius
y1 <- sin(angle_1) * radius
# Where is "pos"?
variant_angle <- angle_for_pos(repeats$pos[1])
x_pos <- cos(variant_angle) * radius
y_pos <- sin(variant_angle) * radius
# Create arcs as quadratic Béziers (visually pleasing and simple)
make_arc_df <- function(x0, y0, x1, y1, arc_color, arc_thick, arc_type, arc_label, n=50, curve=0.37) {
xm <- (x0 + x1)/2
ym <- (y0 + y1)/2
# Outward control point
dx <- x1 - x0; dy <- y1 - y0
ctrl_x <- xm - dy * curve
ctrl_y <- ym + dx * curve
t <- seq(0, 1, length.out = n)
data.frame(
x = (1 - t)^2 * x0 + 2 * (1 - t) * t * ctrl_x + t^2 * x1,
y = (1 - t)^2 * y0 + 2 * (1 - t) * t * ctrl_y + t^2 * y1,
arc_color = arc_color, arc_thick = arc_thick, arc_type = arc_type, arc_label = arc_label,
group = paste0(x0, "_", y0, "_", x1, "_", y1, "_", arc_color)
)
}
arcs_df <- bind_rows(lapply(1:nrow(repeats), function(i) {
make_arc_df(
repeats$x_pos[i], repeats$y_pos[i], repeats$x_rep[i], repeats$y_rep[i],
arc_color = repeats$arc_color[i], arc_thick = repeats$arc_thick[i],
arc_type = repeats$arc_type[i], arc_label = repeats$arc_label[i])
}))
# Final Plot
ggplot() +
# mtDNA circle
geom_path(data = circle_path, aes(x = x, y = y), color = "gray30", linewidth = 2) +
# Position 1
geom_point(aes(x=x1, y=y1), color="black", size=5) +
geom_text(aes(x=x1, y=y1), label = "1", vjust = -1.3, fontface = "bold", size = 5) +
# Variant pos (big golden dot and position number)
geom_point(aes(x=x_pos, y=y_pos), color="goldenrod", size=7) +
geom_text(aes(x=x_pos, y=y_pos), label = unique(repeats$pos), nudge_y=0.11, fontface="bold", size=5.1, color="black") +
# Repeat arcs
geom_path(
data = arcs_df,
aes(x = x, y = y, group = group, color = arc_type, linewidth = arc_thick),
lineend = "round", alpha = 0.82, show.legend = TRUE
) +
scale_color_manual(
values = c("Ref, 16bp" = "#3182bd", "Alt, 16bp" = "#de2d26",
"Ref, 15bp" = "#6baed6", "Alt, 15bp" = "#fc9272"),
name = "Repeat type"
) +
scale_linewidth_identity() +
guides(color = guide_legend(override.aes = list(linewidth = c(7,7,4,4)), ncol=1)) +
coord_equal(expand=FALSE) +
theme_void(base_size = 16) +
labs(
title = "mtDNA: 15/16-bp Repeats Connected To Variant Position",
subtitle = "Genome circle 1–16568 (top=1). Blue=Ref, Red=Alt. Thickness: Repeat Length. Gold dot marks variant.",
x=NULL, y=NULL
) +
theme(
plot.title = element_text(face = "bold", hjust = 0.5),
plot.subtitle = element_text(hjust = 0.5)
)
# === Required libraries ===
library(Biostrings)
library(stringdist)
library(IRanges)
library(dplyr)
library(tidyr)
analyze_mtDNA_repeats <- function(fasta_path,
pos,
ref_nuc,
alt_nuc,
max_flank_left = 20,
max_flank_right = 20,
min_length = 5,
mismatch_percent = 0.2,
major_arc_start,
major_arc_end,
output_path = "../data/2_derived/",
output_prefix = "repeatability_results") {
# Ensure output path exists and create subfolder for pos:Ref>Alt
if(!dir.exists(output_path)) dir.create(output_path, recursive = TRUE)
folder_name <- paste0("pos", pos, "_", ref_nuc, "to", alt_nuc)
full_output_dir <- file.path(output_path, folder_name)
if (!dir.exists(full_output_dir)) dir.create(full_output_dir)
# Load mtDNA sequence
mtDNA <- readDNAStringSet(fasta_path)
if (length(mtDNA) != 1) stop("Fasta must contain exactly one sequence.")
seq <- mtDNA[[1]]
# Helper: Extract motif sequence with asymmetric flanks
get_motif_around_position <- function(seq, pos, left_flank, right_flank) {
start_pos <- max(pos - left_flank, 1)
end_pos <- min(pos + right_flank, length(seq))
subseq(seq, start = start_pos, end = end_pos)
}
# Helper: Find approximate repeats allowing max mismatch (hamming distance)
find_approximate_repeats <- function(seq, motif, max_mismatch) {
motif_str <- as.character(motif)
motif_length <- nchar(motif_str)
seq_length <- length(seq)
all_kmers <- substring(as.character(seq), 1:(seq_length - motif_length + 1),
motif_length:(seq_length))
distances <- stringdist(motif_str, all_kmers, method = "hamming")
matches_pos <- which(distances <= max_mismatch)
matched_kmers <- all_kmers[matches_pos]
data.frame(
repeat.seq = matched_kmers,
repeat.start = matches_pos,
repeat.end = matches_pos + motif_length - 1,
repeat.hamming.distance = distances[matches_pos],
stringsAsFactors = FALSE
)
}
motif_max_length <- max_flank_left + max_flank_right + 1
# Main repeat detection function
get_repeatability_table <- function(seq, pos, ref_nuc, alt_nuc,
min_length, max_flank_left, max_flank_right, mismatch_percent) {
all_results <- data.frame()
for (allele in c(ref_nuc, alt_nuc)) {
allele_label <- ifelse(allele == ref_nuc, "Ref", "Alt")
seq_allele <- seq
if (allele != ref_nuc) {
seq_chars <- unlist(strsplit(as.character(seq), split = ""))
seq_chars[pos] <- allele
seq_allele <- DNAString(paste(seq_chars, collapse = ""))
}
for (motif_len in min_length:motif_max_length) {
for (left_flank in 0:(motif_len - 1)) {
right_flank <- motif_len - left_flank - 1
if (left_flank <= max_flank_left && right_flank <= max_flank_right) {
motif_seq <- get_motif_around_position(seq_allele, pos, left_flank, right_flank)
motif_string <- as.character(motif_seq)
this_length <- nchar(motif_string)
max_mismatch_allowed <- floor(mismatch_percent * this_length)
repeats_df <- find_approximate_repeats(seq_allele, motif_seq, max_mismatch_allowed)
if (nrow(repeats_df) > 0) {
repeats_df$motif.seq <- motif_string
repeats_df$motif.length <- this_length
repeats_df$motif.start <- max(pos - left_flank, 1)
repeats_df$motif.end <- min(pos + right_flank, length(seq_allele))
repeats_df$nuc <- allele
repeats_df$RefAlt <- allele_label
repeats_df$pos <- pos
repeats_df <- repeats_df[, c(
"pos", "nuc", "RefAlt", "motif.seq", "motif.length", "motif.start", "motif.end",
"repeat.seq", "repeat.start", "repeat.end", "repeat.hamming.distance"
)]
all_results <- rbind(all_results, repeats_df)
}
}
}
}
}
rownames(all_results) <- NULL
return(all_results)
}
# Filter 1: remove repeats overlapping motif region (self-overlaps)
filter_self_overlaps <- function(df) {
df %>% filter(motif.end < repeat.start | repeat.end < motif.start)
}
# Filter 2: remove nested repeats fully contained inside longer repeats per allele
remove_nested_repeats <- function(repeats_df) {
filtered_repeats <- data.frame()
for (allele in unique(repeats_df$nuc)) {
allele_repeats <- repeats_df %>% filter(nuc == allele)
allele_repeats <- allele_repeats %>% arrange(desc(EffectiveLength))
kept_intervals <- IRanges()
for (i in seq_len(nrow(allele_repeats))) {
current_start <- allele_repeats$repeat.start[i]
current_end <- allele_repeats$repeat.end[i]
current_range <- IRanges(start = current_start, end = current_end)
is_nested <- if (length(kept_intervals) == 0) FALSE else
any(start(current_range) >= start(kept_intervals) & end(current_range) <= end(kept_intervals))
if (!is_nested) {
filtered_repeats <- rbind(filtered_repeats, allele_repeats[i, ])
kept_intervals <- c(kept_intervals, current_range)
}
}
}
rownames(filtered_repeats) <- NULL
return(filtered_repeats)
}
# --- Execute pipeline ---
all_repeats <- get_repeatability_table(seq, pos, ref_nuc, alt_nuc,
min_length, max_flank_left, max_flank_right, mismatch_percent)
filtered_repeats <- filter_self_overlaps(all_repeats)
filtered_repeats$EffectiveLength <- filtered_repeats$motif.length - filtered_repeats$repeat.hamming.distance
non_nested_repeats <- remove_nested_repeats(filtered_repeats)
# Correct factor ordering to order Ref before Alt in sorting
non_nested_repeats$RefAlt <- factor(non_nested_repeats$RefAlt, levels = c("Ref", "Alt"))
# Sort by descending EffectiveLength, then RefAlt with Ref repeats first
all_repeats_sorted <- non_nested_repeats %>%
arrange(desc(EffectiveLength), RefAlt)
# --- Top5 summary within major arc region ---
major_arc_repeats <- non_nested_repeats %>%
filter(repeat.start >= major_arc_start, repeat.end <= major_arc_end)
top5_lengths <- major_arc_repeats %>%
group_by(RefAlt, EffectiveLength) %>%
summarise(Count = n(), .groups = "drop") %>%
filter(EffectiveLength > 0) %>%
arrange(desc(EffectiveLength)) %>%
group_by(RefAlt) %>%
mutate(rank = row_number()) %>%
ungroup() %>%
filter(rank <= 5)
efflen_top <- unique(sort(top5_lengths$EffectiveLength, decreasing = TRUE))[1:5]
summary_table <- tibble(EffectiveLength = efflen_top) %>%
left_join(top5_lengths %>% filter(RefAlt == "Ref") %>%
select(EffectiveLength, Ref_Count = Count), by = "EffectiveLength") %>%
left_join(top5_lengths %>% filter(RefAlt == "Alt") %>%
select(EffectiveLength, Alt_Count = Count), by = "EffectiveLength") %>%
mutate(
Ref_Count = ifelse(is.na(Ref_Count), 0, Ref_Count),
Alt_Count = ifelse(is.na(Alt_Count), 0, Alt_Count)
)
# --- Write outputs ---
write.csv(all_repeats_sorted,
file = file.path(full_output_dir, paste0(output_prefix, "_all_repeats.csv")),
row.names = FALSE)
write.csv(summary_table,
file = file.path(full_output_dir, paste0(output_prefix, "_major_arc_summary_top5.csv")),
row.names = FALSE)
message("Output files saved to folder: ", full_output_dir)
invisible(list(
all_repeats = all_repeats_sorted,
summary_top5_major_arc = summary_table,
output_folder = full_output_dir
))
}
#  8251 G>A
analyze_mtDNA_repeats(
fasta_path      = "../data/1_raw/Homo_sapients.mtDNA.fasta",
pos             = 8251,
ref_nuc         = "G",
alt_nuc         = "A",
max_flank_left  = 20,
max_flank_right = 20,
min_length      = 5,
mismatch_percent= 0.2,
major_arc_start = 5798,
major_arc_end   = 16568,
output_path     = "../data/2_derived/",
output_prefix   = "my_mtDNA_repeat"
)
analyze_mtDNA_repeats(
fasta_path      = "../data/1_raw/Homo_sapients.mtDNA.fasta",
pos             = 8251,
ref_nuc         = "G",
alt_nuc         = "A",
max_flank_left  = 20,
max_flank_right = 20,
min_length      = 5,
mismatch_percent= 0.1,
major_arc_start = 5798,
major_arc_end   = 16568,
output_path     = "../data/2_derived/",
output_prefix   = "my_mtDNA_repeat"
)
#  8251 G>A
analyze_mtDNA_repeats(
fasta_path      = "../data/1_raw/Homo_sapients.mtDNA.fasta",
pos             = 8251,
ref_nuc         = "G",
alt_nuc         = "A",
max_flank_left  = 20,
max_flank_right = 20,
min_length      = 5,
mismatch_percent= 0.0,
major_arc_start = 5798,
major_arc_end   = 16568,
output_path     = "../data/2_derived/",
output_prefix   = "my_mtDNA_repeat"
)
analyze_mtDNA_repeats(
fasta_path      = "../data/1_raw/Homo_sapients.mtDNA.fasta",
pos             = 8251,
ref_nuc         = "G",
alt_nuc         = "A",
max_flank_left  = 20,
max_flank_right = 20,
min_length      = 5,
mismatch_percent= 0,
major_arc_start = 5798,
major_arc_end   = 16568,
output_path     = "../data/2_derived/",
output_prefix   = "my_mtDNA_repeat"
)
#  8472 C>T
analyze_mtDNA_repeats(
fasta_path      = "../data/1_raw/Homo_sapients.mtDNA.fasta",
pos             = 8472,
ref_nuc         = "C",
alt_nuc         = "T",
max_flank_left  = 20,
max_flank_right = 20,
min_length      = 5,
mismatch_percent= 0.2,
major_arc_start = 5798,
major_arc_end   = 16568,
output_path     = "../data/2_derived/",
output_prefix   = "my_mtDNA_repeat"
)
#  8251 G>A
analyze_mtDNA_repeats(
fasta_path      = "../data/1_raw/Homo_sapients.mtDNA.fasta",
pos             = 8251,
ref_nuc         = "G",
alt_nuc         = "A",
max_flank_left  = 20,
max_flank_right = 20,
min_length      = 5,
mismatch_percent= 0.2,
major_arc_start = 5798,
major_arc_end   = 16568,
output_path     = "../data/2_derived/",
output_prefix   = "my_mtDNA_repeat"
)
#  12705 C>T
analyze_mtDNA_repeats(
fasta_path      = "../data/1_raw/Homo_sapients.mtDNA.fasta",
pos             = 12705,
ref_nuc         = "C",
alt_nuc         = "T",
max_flank_left  = 20,
max_flank_right = 20,
min_length      = 5,
mismatch_percent= 0.2,
major_arc_start = 5798,
major_arc_end   = 16568,
output_path     = "../data/2_derived/",
output_prefix   = "my_mtDNA_repeat"
)
analyze_mtDNA_repeats(
fasta_path      = "../data/1_raw/Homo_sapients.mtDNA.fasta",
pos             = 14798,
ref_nuc         = "T",
alt_nuc         = "C",
max_flank_left  = 20,
max_flank_right = 20,
min_length      = 5,
mismatch_percent= 0.2,
major_arc_start = 5798,
major_arc_end   = 16568,
output_path     = "../data/2_derived/",
output_prefix   = "my_mtDNA_repeat"
)
analyze_mtDNA_repeats(
fasta_path      = "../data/1_raw/Homo_sapients.mtDNA.fasta",
pos             = 16223,
ref_nuc         = "C",
alt_nuc         = "T",
max_flank_left  = 20,
max_flank_right = 20,
min_length      = 5,
mismatch_percent= 0.2,
major_arc_start = 5798,
major_arc_end   = 16568,
output_path     = "../data/2_derived/",
output_prefix   = "my_mtDNA_repeat"
)
